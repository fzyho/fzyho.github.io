<!DOCTYPE html>
<html><meta charset="utf-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta name="keywords" content="">
<meta name="description" content="">

<title>读书笔记-The Art Of Multiprocessor Programing(三)</title>

<link rel="icon" href="https://fzyho.github.io/theme/head-icon-3.png">


<meta name="generator" content="Hugo 0.107.0">




<link rel="stylesheet" href="/css/main.min.css">
<div class="fixed-header-slide">
    <div class="fixed-header-wrap">
        <header class="header">
            <nav class="nav">
                <div class="logo">
                    
                    <a href="https://fzyho.github.io/">
                        <img src="/theme/title-1.png" alt="logo" aria-label="logo"
                            height="30px">
                    </a>
                </div>
                <ul class="menu">
                    <li>
                        <a href="https://fzyho.github.io/docs/quic" title="QUIC协议(RFC)">
                            <span>QUIC协议(RFC)</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://fzyho.github.io/archives" title="Archives">
                            <span>Archives</span>
                        </a>
                    </li></ul>
            </nav>
            
        </header>
    </div>
</div><body>
		<main class="content">







  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    'use strict';
    
    
    var tables = document.querySelectorAll('.post-body > table');
    for (let i = 0; i < tables.length; i++) {
      var table = tables[i];
      var wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentElement.replaceChild(wrapper, table);
      wrapper.appendChild(table);
    }
    


    
    
      var mathElements = document.getElementsByClassName('math');
      var options = {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "$$\n", right: "\n$$", display: true },
          { left: "$", right: "$", display: false },
        ],
      };

      renderMathInElement(document.querySelector('.post-body'), options);
    
    
  });
</script>


<div class="wrapper-toc">
    <div class="toc">
		
		
		
			<div class="toc-content">
			
				
				
				
				<div style="margin: auto; text-align: center;font-weight: bolder;">- 目录 -</div>
				
				
				<ul></ul>
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#%e5%b9%b6%e8%a1%8c%e9%98%9f%e5%88%97%e4%b8%8eaba%e9%97%ae%e9%a2%98" onclick="onNavClick(`#并行队列与aba问题-nav`)" id="并行队列与aba问题-nav" class="animated-visibility">
										并行队列与ABA问题
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1%e6%b1%a0%e7%9a%84%e5%ae%9a%e4%b9%89%e4%b8%8e%e5%bd%a2%e5%bc%8f" onclick="onNavClick(`#1池的定义与形式-nav`)" id="1池的定义与形式-nav" class="animated-visibility">
										1、池的定义与形式
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e9%83%a8%e5%88%86%e6%9c%89%e7%95%8c%e9%98%9f%e5%88%97an-bounded-partial-queue" onclick="onNavClick(`#2部分有界队列an-bounded-partial-queue-nav`)" id="2部分有界队列an-bounded-partial-queue-nav" class="animated-visibility">
										2、部分有界队列(An Bounded Partial Queue)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#3%e5%ae%8c%e5%85%a8%e6%97%a0%e7%95%8c%e9%98%9f%e5%88%97an-unbounded-total-queue" onclick="onNavClick(`#3完全无界队列an-unbounded-total-queue-nav`)" id="3完全无界队列an-unbounded-total-queue-nav" class="animated-visibility">
										3、完全无界队列(An Unbounded Total Queue)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#4%e6%97%a0%e9%94%81%e6%97%a0%e7%95%8c%e9%98%9f%e5%88%97lock-free-unbounded-queue" onclick="onNavClick(`#4无锁无界队列lock-free-unbounded-queue-nav`)" id="4无锁无界队列lock-free-unbounded-queue-nav" class="animated-visibility">
										4、无锁无界队列(Lock-Free Unbounded Queue)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
								
									</ul>
								
							
							
								<li>
									<a href="#%e5%b9%b6%e5%8f%91%e6%a0%88%e4%b8%8e%e6%b6%88%e9%99%a4" onclick="onNavClick(`#并发栈与消除-nav`)" id="并发栈与消除-nav" class="animated-visibility">
										并发栈与消除
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1%e6%97%a0%e9%94%81%e7%9a%84%e6%97%a0%e7%95%8c%e6%a0%88lock-free-unbounded-stack" onclick="onNavClick(`#1无锁的无界栈lock-free-unbounded-stack-nav`)" id="1无锁的无界栈lock-free-unbounded-stack-nav" class="animated-visibility">
										1、无锁的无界栈(Lock Free Unbounded Stack)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e6%b6%88%e9%99%a4elimination" onclick="onNavClick(`#2消除elimination-nav`)" id="2消除elimination-nav" class="animated-visibility">
										2、消除(Elimination)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#3%e6%b6%88%e9%99%a4%e5%bc%8f%e5%90%8e%e9%80%80%e6%a0%88eliminationbackoffstack" onclick="onNavClick(`#3消除式后退栈eliminationbackoffstack-nav`)" id="3消除式后退栈eliminationbackoffstack-nav" class="animated-visibility">
										3、消除式后退栈(EliminationBackoffStack)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1%e6%97%a0%e9%94%81%e4%ba%a4%e6%8d%a2%e6%9c%baa-lock-free-exchanger" onclick="onNavClick(`#1无锁交换机a-lock-free-exchanger-nav`)" id="1无锁交换机a-lock-free-exchanger-nav" class="animated-visibility">
										1、无锁交换机(A Lock-Free Exchanger)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e6%b6%88%e9%99%a4%e6%95%b0%e7%bb%84eliminationarray" onclick="onNavClick(`#2消除数组eliminationarray-nav`)" id="2消除数组eliminationarray-nav" class="animated-visibility">
										2、消除数组(EliminationArray)
									</a>
								</li>
							
							
						
					
				
				</ul>
			</div>
		
    </div>
</div>


<div class="post-list">
	<div class="single-post">
		<div class="post-head-wrapper">
			<div class="post-title">
				读书笔记-The Art Of Multiprocessor Programing(三)
				
			</div>
			<div class="post-meta">
    <time class="post-meta-date" itemprop="datePublished">
        2020-08-11
    </time>

    <ul class="post-meta-tags">
        
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 28 24">
    <path d="M9.777 2l11.395 11.395-7.779 7.777-11.393-11.39v-7.782h7.777zm.828-2l-10.604.001v10.609l13.392 13.39 10.607-10.605-13.395-13.395zm-6.019 7.414c-.78-.781-.779-2.047.002-2.827.781-.782 2.047-.781 2.826-.003.783.783.782 2.049 0 2.83-.779.781-2.045.781-2.828 0zm5.824 7.947l-3.537-3.535.709-.707 3.535 3.535-.707.707zm4.242 0l-5.658-5.656.708-.708 5.657 5.657-.707.707zm2.121-2.121l-5.657-5.657.707-.707 5.657 5.657-.707.707z"/>
</svg>
        
        
            <li><a href="https://fzyho.github.io/tags/java/" title="java">java</a></li>
        
            <li><a href="https://fzyho.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程">多线程</a></li>
        
            <li><a href="https://fzyho.github.io/tags/%E5%B9%B6%E5%8F%91/" title="并发">并发</a></li>
        
    </ul>
</div>
		</div>
		<div class="post-body-wrapper">
			<div class="post-body" v-pre>
				
				<h2 id="并行队列与aba问题">并行队列与ABA问题<a hidden class="anchor" aria-hidden="true" href="#并行队列与aba问题">#</a></h2>
<h3 id="1池的定义与形式">1、池的定义与形式<a hidden class="anchor" aria-hidden="true" href="#1池的定义与形式">#</a></h3>
<p>池，即为存放东西的一个容器，的作用往往与生产者——消费者缓冲区的作用相同。<!-- raw HTML omitted -->
池有以下几种不同的变化形式：</p>
<ul>
<li>池可以是有界或无界的。有界池存放有限个元素，而无限池可以存放任意数量的元素。当需要保持生产者与消费者之间的松弛同步，即生产者不要过快超过消费者时，就要用到有界池。有界池的实现可能要比无限池简单(==并不觉得，反而感觉恰恰相反==)，当不用设定固定的界限来限制生产者与消费者之间的速率时，可以使用无限池。</li>
<li>池的方法可以是<strong>完全、部分或者同步的</strong>
<ul>
<li><strong>完全(Total)：</strong> 若一个方法的调用<strong>不需要</strong>等待某个条件成立，则该方法时<strong>完全的</strong>。例如，一个试图从空池中删除元素的get()调用 或者 往满池中添加元素的set()调用<strong>将立刻返回错误码或者抛出一个异常</strong>。</li>
<li><strong>部分(Partial)：</strong> 若一个方法的调用****需要**等待某个条件成立，则该方法是部分的。例如，空池中删除元素/满池中插入元素 将会阻塞直到满足条件。</li>
<li><strong>同步(synchronous)：</strong> 若一个方法需要等待另一个方法与它的调用间隔相重叠，则称该方法是同步的。例如，在一个同步池中，一个向池中添加元素的方法将会被阻塞直到该添加的元素被取走。同样删除元素的调用也会被阻塞直到有元素被添加为止(<strong>此方法同时也是部分的</strong>)。</li>
</ul>
</li>
</ul>
<h3 id="2部分有界队列an-bounded-partial-queue">2、部分有界队列(An Bounded Partial Queue)<a hidden class="anchor" aria-hidden="true" href="#2部分有界队列an-bounded-partial-queue">#</a></h3>
<p>队列本身包含<code>Head</code>和<code>Tail</code>字段。与第九章的链表一样，此处<code>Head</code>和<code>Tail</code>充当哨兵节点——其值是无意义的。而不同的是，第九章的哨兵节点是固定不变的，而这里的队列则是不断地更换哨兵节点。对于<code>enq()</code>和<code>deq()</code>方法，分别使用不同的锁，由此保证入队不会锁住出队。
对于唤醒丢失(lost-wakeup)问题，由于在await之前，已获得condition对应的锁，保证await之前其他线程无法signal，故没有唤醒丢失问题。<!-- raw HTML omitted -->
有一点需要注意的就是——由于并发操作，<code>Head</code>和<code>Tail</code>字段不一定始终指向头/尾节点。</p>
<p>另外此实现有一个缺点就是并发的<code>enq()</code>和<code>deq()</code>互相干扰，所有方法对<code>size</code>字段调用的<code>getAndIncrement</code>或<code>getAndDecreament</code>比一般的读写开销更大，且能引起顺序瓶颈*==并不明白这话什么意思==*<!-- raw HTML omitted -->
可以通过将<code>size</code>分成两个计数器——<code>enqSideSize</code>和<code>deqSideSize</code>，enq增1，deq减1。<code>enq()</code>检测<code>enqSideSize</code>&lt;<code>capacity</code>则继续执行；若<code>enqSideSize</code>==<code>capacity</code>则锁住<code>deqLock</code>并将<code>deqSideSize</code>加到<code>enqSideSize</code>中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">BoundedQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">size</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">volatile</span> <span class="n">Node</span> <span class="n">head</span><span class="o">,</span> <span class="n">tail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">enqLock</span><span class="o">,</span> <span class="n">deqLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">final</span> <span class="n">Condition</span> <span class="n">notEmptyCondition</span><span class="o">,</span> <span class="n">notFullCondition</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">BoundedQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">head</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">tail</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">enqLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">deqLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">notFullCondition</span> <span class="o">=</span> <span class="n">enqLock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">notEmptyCondition</span> <span class="o">=</span> <span class="n">deqLock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">enq</span><span class="o">(</span><span class="n">T</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">boolean</span> <span class="n">mustWakeDequeuers</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">enqLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span> <span class="o">(</span><span class="n">size</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">notFullCondition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">tail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">size</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">mustWakeDequeuers</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">enqLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">mustWakeDequeuers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">deqLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">notEmptyCondition</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">deqLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">deq</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">T</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">boolean</span> <span class="n">mustWakeEnqueuers</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">deqLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span> <span class="o">(</span><span class="n">size</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">notEmptyCondition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">result</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">size</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">mustWakeEnqueuers</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">deqLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">mustWakeEnqueuers</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">enqLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">notFullCondition</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">enqLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="kd">class</span> <span class="nc">Node</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">final</span> <span class="n">T</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kd">volatile</span> <span class="n">Node</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">Node</span><span class="o">(</span><span class="n">T</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3完全无界队列an-unbounded-total-queue">3、完全无界队列(An Unbounded Total Queue)<a hidden class="anchor" aria-hidden="true" href="#3完全无界队列an-unbounded-total-queue">#</a></h3>
<p>没有<code>capacity</code>的限制，逻辑相对于有界部分队列会简单些。由于队列中的哨兵节点永远不会被删除，所以enq总会成功。而如果队列为空——<code>head.next == null</code>，则<code>deq</code>会失败。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">enq</span><span class="o">(</span><span class="n">T</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">enqLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">tail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">tail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">enqLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">deq</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">T</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">deqLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">throw</span> <span class="k">new</span> <span class="n">EmptyException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">result</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">deqLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4无锁无界队列lock-free-unbounded-queue">4、无锁无界队列(Lock-Free Unbounded Queue)<a hidden class="anchor" aria-hidden="true" href="#4无锁无界队列lock-free-unbounded-queue">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">enq</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">tail</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">next</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="na">next</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">last</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">last</span><span class="o">.</span><span class="na">next</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">tail</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">last</span><span class="o">,</span> <span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">tail</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">last</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">deq</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">tail</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">next</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">!=</span> <span class="n">head</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">==</span> <span class="n">last</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">throw</span> <span class="k">new</span> <span class="n">EmptyException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="n">tail</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">last</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">T</span> <span class="n">value</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">head</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">first</span><span class="o">,</span> <span class="n">next</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="并发栈与消除">并发栈与消除<a hidden class="anchor" aria-hidden="true" href="#并发栈与消除">#</a></h2>
<h3 id="1无锁的无界栈lock-free-unbounded-stack">1、无锁的无界栈(Lock Free Unbounded Stack)<a hidden class="anchor" aria-hidden="true" href="#1无锁的无界栈lock-free-unbounded-stack">#</a></h3>
<p>Stack的出口和入口都是<code>top</code>，因此只要控制<code>top</code>更新的原子性和可见性，即可实现Stack的线程安全。因此通过<code>AtomicReference</code>的<code>compareAndSet</code>来实现<code>top</code>的更新，即可实现无锁的并发栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockFreeStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">top</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MIN_DELAY</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_DELAY</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Backoff</span> <span class="n">backoff</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Backoff</span><span class="o">(</span><span class="n">MIN_DELAY</span><span class="o">,</span> <span class="n">MAX_DELAY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryPush</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">node</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">node</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">tryPush</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">backoff</span><span class="o">.</span><span class="na">backoff</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="n">Node</span> <span class="nf">tryPop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">oldTop</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">throw</span> <span class="k">new</span> <span class="n">EmptyException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">newTop</span> <span class="o">=</span> <span class="n">oldTop</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">newTop</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">returnNode</span> <span class="o">=</span> <span class="n">tryPop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">returnNode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">returnNode</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">backoff</span><span class="o">.</span><span class="na">backoff</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当然，如此的无锁Stack的<code>top</code>字段是一个争用源，而且还是一个一个顺序瓶颈——方法调用只能根据<code>top</code>字段的<code>CompareAndSet</code>方法的成功返回的顺序 依次顺序进行。</p>
<h3 id="2消除elimination">2、消除(Elimination)<a hidden class="anchor" aria-hidden="true" href="#2消除elimination">#</a></h3>
<p>由于LockFreeStack存在顺序瓶颈(Sequential Bottleneck)，为降低其压力，可利用stack的一种现象——若一个<code>push</code>后面跟着<code>pop</code>，则两个操作相互抵消，stack的状态相当于没有发生改变。<!-- raw HTML omitted -->
如下图所示，可以通过使用一个数组作为缓冲来消除其他线程。其中，线程随机选取一个数组位置的来尝试发现互补的调用。互补的<code>push</code>和<code>pop</code>调用对则相互交换数值并返回。若不是互补的(如 <code>push</code>和<code>push</code>，<code>pop</code>和<code>pop</code>)，则要么在新的数组位置中重新尝试，要么直接访问共享的数据结构(本章即 LockFreeStack)。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/C54B8819167E43A98D351C7A555DEA59?method=download&amp;shareKey=26a75db4c87fa9a330e1901122037050" alt="image"><!-- raw HTML omitted -->
通过将EliminationArray作为LockFreeStack的后退模式——每个线程访问LockFreeStack失败后(即<code>compareAndSet()</code>失败)，该线程则尝试使用数组来消除它的调用。若不能消除，则再重新访问LockFreeStack。</p>
<h3 id="3消除式后退栈eliminationbackoffstack">3、消除式后退栈(EliminationBackoffStack)<a hidden class="anchor" aria-hidden="true" href="#3消除式后退栈eliminationbackoffstack">#</a></h3>
<h4 id="1无锁交换机a-lock-free-exchanger">1、无锁交换机(A Lock-Free Exchanger)<a hidden class="anchor" aria-hidden="true" href="#1无锁交换机a-lock-free-exchanger">#</a></h4>
<p>从一个高的层次来看，交换机让第一个到达的线程写入自己的值，然后旋转等待直到第二个线程的到来。随后，第二个线程检测到第一个线程在等待，则读取写入的值并向交换机发出信号。两方都读取到值后，返回。若第二个线程没有出现，则第一个线程超时使得其能够离开交换机继续操作。<!-- raw HTML omitted --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">LockFreeExchanger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">EMPTY</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">WAITING</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">BUSY</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">slot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">exchange</span><span class="o">(</span><span class="n">T</span> <span class="n">myItem</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">long</span> <span class="n">timeBound</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">nanos</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span><span class="o">[]</span> <span class="n">stampHolder</span> <span class="o">=</span> <span class="o">{</span> <span class="n">EMPTY</span> <span class="o">};</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">timeBound</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">T</span> <span class="n">yrItem</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stampHolder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">stampHolder</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="o">(</span><span class="n">stamp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">EMPTY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">slot</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">yrItem</span><span class="o">,</span> <span class="n">myItem</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">while</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">timeBound</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">yrItem</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stampHolder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="o">(</span><span class="n">stampHolder</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">BUSY</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">							<span class="n">slot</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">							<span class="k">return</span> <span class="n">yrItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">						<span class="o">}</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="o">(</span><span class="n">slot</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">myItem</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">yrItem</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stampHolder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">						<span class="n">slot</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="n">yrItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">WAITING</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">slot</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">yrItem</span><span class="o">,</span> <span class="n">myItem</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">,</span> <span class="n">BUSY</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="n">yrItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">BUSY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="o">:</span> <span class="c1">// impossible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上述代码所示，一个线程读取slot状态，有如下流程：</p>
<ul>
<li>若状态为<code>EMPTY</code>，尝试将数据写入slot中并将状态设置为<code>WAITING</code>。若失败，则有其他线程成功，重试；若成功，则自旋以等待另一线程将其交换。另一线程交换数据后，会将状态设置为<code>BUSY</code>，从而告知正在自旋等待的线程已完成交换，可以读取slot中的数据并更新状态为<code>EMPTY</code>。若超时，则将slot中的数据和状态重置。</li>
<li>若状态为<code>WAITING</code>，则说明某线程正在自选等待且slot有数据，因此通过<code>compareAndSet()</code>方法获取数据并更新状态为<code>BUSY</code>，以通知该线程结束自旋。若<code>compareAndSet()</code>失败，则重试直至超时。</li>
<li>若状态为<code>BUSY</code>，说明另外有两个线程正在通过此slot进行交换，此线程需要重试以等待交换结束。</li>
</ul>
<h4 id="2消除数组eliminationarray">2、消除数组(EliminationArray)<a hidden class="anchor" aria-hidden="true" href="#2消除数组eliminationarray">#</a></h4>
<p>EliminationArray即是一个交换机(Exchanger)数组，要进行交换的线程从数组中随机选择一个对象，并调用该对象的<code>excahnge()</code>方法来与另一线程交换数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">EliminationArray</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">duration</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">LockFreeExchanger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">exchanger</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">Random</span> <span class="n">random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">EliminationArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">exchanger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockFreeExchanger</span><span class="o">[</span><span class="n">capacity</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">exchanger</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockFreeExchanger</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">visit</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span> <span class="n">range</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">range</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">exchanger</span><span class="o">[</span><span class="n">slot</span><span class="o">].</span><span class="na">exchange</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>每次随机数组时，线程可动态选择数组的子范围。子范围的选择由RangePolicy对象决定，每个调用<code>push/pop</code>的线程都有一个ThreadLocal的RangePolicy对象。EliminationArray的范围选择是重要的，范围越大，线程在<code>BUSY</code>状态的交换机上等待的可能性越低。因此线程越少，范围应该越小。<strong>因此一种简单的范围选择策略是——随着失败次数的增加而收缩范围</strong>。</p>
<blockquote>
<p>本章实现的EliminationArray模块，实际上效率并不算高效。<a href="http://www.cs.tau.ac.il/~shanir/nir-pubs-web/Papers/SPAA2005.pdf"> Using elimination to implement scalable and lock-free fifo queues</a>中提出了一种更加高效的实现。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">EliminationBackoffStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">LockFreeStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="n">EliminationArray</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">eliminationArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EliminationArray</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">RangePolicy</span><span class="o">&gt;</span> <span class="n">policy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">RangePolicy</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">protected</span> <span class="kd">synchronized</span> <span class="n">RangePolicy</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="k">new</span> <span class="n">RangePolicy</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">RangePolicy</span> <span class="n">rangePolicy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">tryPush</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">T</span> <span class="n">otherValue</span> <span class="o">=</span> <span class="n">eliminationArray</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">rangePolicy</span><span class="o">.</span><span class="na">getRange</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="o">(</span><span class="n">otherValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationSuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span><span class="o">;</span> <span class="c1">// exchanged with pop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationTimeout</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">RangePolicy</span> <span class="n">rangePolicy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">popNode</span> <span class="o">=</span> <span class="n">tryPop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">popNode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">popNode</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">T</span> <span class="n">otherValue</span> <span class="o">=</span> <span class="n">eliminationArray</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">rangePolicy</span><span class="o">.</span><span class="na">getRange</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="o">(</span><span class="n">otherValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationSuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="n">otherValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationTimeout</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
			</div>
			<div class="post-copyright">
				<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
	<img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
</a>
<br />本作品采用
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>
进行许可。
<br />
转载时请附上原文链接以注明出处，图片在使用时请保留全部内容(可适当缩放)并附上图片所属的文章链接。若进行商业性使用，请先联系笔者获取许可。
			</div>
		</div>
		<div class="post-footer-wrapper">
			<hr class="hr-fade"/>
			<div class="post-comment-wrapper"></div> 
		</div>
	</div>
</div>

</main>
	</body>
</html>

<!DOCTYPE html>
<html><meta charset="utf-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta name="keywords" content="">
<meta name="description" content="">

<title>读书笔记-The Art Of Multiprocessor Programing(四)</title>

<link rel="icon" href="https://fzyho.github.io/theme/head-icon-3.png">


<meta name="generator" content="Hugo 0.107.0">




<link rel="stylesheet" href="/css/main.min.css">
<div class="fixed-header-slide">
    <div class="fixed-header-wrap">
        <header class="header">
            <nav class="nav">
                <div class="logo">
                    
                    <a href="https://fzyho.github.io/">
                        <img src="/theme/title-1.png" alt="logo" aria-label="logo"
                            height="30px">
                    </a>
                </div>
                <ul class="menu">
                    <li>
                        <a href="https://fzyho.github.io/docs/quic" title="QUIC协议(RFC)">
                            <span>QUIC协议(RFC)</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://fzyho.github.io/archives" title="Archives">
                            <span>Archives</span>
                        </a>
                    </li></ul>
            </nav>
            
        </header>
    </div>
</div><body>
		<main class="content">







  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    'use strict';
    
    
    var tables = document.querySelectorAll('.post-body > table');
    for (let i = 0; i < tables.length; i++) {
      var table = tables[i];
      var wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentElement.replaceChild(wrapper, table);
      wrapper.appendChild(table);
    }
    


    
    
      var mathElements = document.getElementsByClassName('math');
      var options = {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "$$\n", right: "\n$$", display: true },
          { left: "$", right: "$", display: false },
        ],
      };

      renderMathInElement(document.querySelector('.post-body'), options);
    
    
  });
</script>


<div class="wrapper-toc">
    <div class="toc">
		
		
		
			<div class="toc-content">
			
				
				
				
				<div style="margin: auto; text-align: center;font-weight: bolder;">- 目录 -</div>
				
				
				<ul></ul>
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#%e5%bc%82%e6%ad%a5%e6%89%a7%e8%a1%8c%e8%b0%83%e5%ba%a6%e5%92%8c%e5%b7%a5%e4%bd%9c%e5%88%86%e9%85%8d" onclick="onNavClick(`#异步执行调度和工作分配-nav`)" id="异步执行调度和工作分配-nav" class="animated-visibility">
										异步执行、调度和工作分配
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1" onclick="onNavClick(`#1-nav`)" id="1-nav" class="animated-visibility">
										1、
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e5%b7%a5%e4%bd%9c%e5%88%86%e9%85%8d" onclick="onNavClick(`#2工作分配-nav`)" id="2工作分配-nav" class="animated-visibility">
										2、工作分配
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1%e5%b7%a5%e4%bd%9c%e7%aa%83%e5%8f%96" onclick="onNavClick(`#1工作窃取-nav`)" id="1工作窃取-nav" class="animated-visibility">
										1、工作窃取
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
								
									</ul>
								
							
							
								<li>
									<a href="#3%e5%b7%a5%e4%bd%9c%e7%aa%83%e5%8f%96%e7%9a%84%e5%8f%8c%e7%ab%af%e9%98%9f%e5%88%97work-stealing-dequeues" onclick="onNavClick(`#3工作窃取的双端队列work-stealing-dequeues-nav`)" id="3工作窃取的双端队列work-stealing-dequeues-nav" class="animated-visibility">
										3、工作窃取的双端队列(Work-Stealing Dequeues)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1%e6%9c%89%e7%95%8c%e5%b7%a5%e4%bd%9c%e7%aa%83%e5%8f%96%e5%8f%8c%e7%ab%af%e9%98%9f%e5%88%97a-bounded-work-stealing-dequeue" onclick="onNavClick(`#1有界工作窃取双端队列a-bounded-work-stealing-dequeue-nav`)" id="1有界工作窃取双端队列a-bounded-work-stealing-dequeue-nav" class="animated-visibility">
										1、有界工作窃取双端队列(A Bounded Work-Stealing Dequeue)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e6%97%a0%e7%95%8c%e5%b7%a5%e4%bd%9c%e7%aa%83%e5%8f%96%e5%8f%8c%e7%ab%af%e9%98%9f%e5%88%97an-unbounded-work-stealing-dequeue" onclick="onNavClick(`#2无界工作窃取双端队列an-unbounded-work-stealing-dequeue-nav`)" id="2无界工作窃取双端队列an-unbounded-work-stealing-dequeue-nav" class="animated-visibility">
										2、无界工作窃取双端队列(An Unbounded Work-Stealing DEQueue)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
								
									</ul>
								
							
							
								<li>
									<a href="#3%e5%b7%a5%e4%bd%9c%e5%b9%b3%e8%a1%a1" onclick="onNavClick(`#3工作平衡-nav`)" id="3工作平衡-nav" class="animated-visibility">
										3、工作平衡
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#1%e6%97%a0%e9%94%81%e7%9a%84%e6%97%a0%e7%95%8c%e6%a0%88lock-free-unbounded-stack" onclick="onNavClick(`#1无锁的无界栈lock-free-unbounded-stack-nav`)" id="1无锁的无界栈lock-free-unbounded-stack-nav" class="animated-visibility">
										1、无锁的无界栈(Lock Free Unbounded Stack)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e6%b6%88%e9%99%a4elimination" onclick="onNavClick(`#2消除elimination-nav`)" id="2消除elimination-nav" class="animated-visibility">
										2、消除(Elimination)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#3%e6%b6%88%e9%99%a4%e5%bc%8f%e5%90%8e%e9%80%80%e6%a0%88eliminationbackoffstack" onclick="onNavClick(`#3消除式后退栈eliminationbackoffstack-nav`)" id="3消除式后退栈eliminationbackoffstack-nav" class="animated-visibility">
										3、消除式后退栈(EliminationBackoffStack)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
								
									<ul>
								
							
							
							
								<li>
									<a href="#1%e6%97%a0%e9%94%81%e4%ba%a4%e6%8d%a2%e6%9c%baa-lock-free-exchanger" onclick="onNavClick(`#1无锁交换机a-lock-free-exchanger-nav`)" id="1无锁交换机a-lock-free-exchanger-nav" class="animated-visibility">
										1、无锁交换机(A Lock-Free Exchanger)
									</a>
								</li>
							
							
						
					
				
					
					
						
							
							
							
							
							
								<li>
									<a href="#2%e6%b6%88%e9%99%a4%e6%95%b0%e7%bb%84eliminationarray" onclick="onNavClick(`#2消除数组eliminationarray-nav`)" id="2消除数组eliminationarray-nav" class="animated-visibility">
										2、消除数组(EliminationArray)
									</a>
								</li>
							
							
						
					
				
				</ul>
			</div>
		
    </div>
</div>


<div class="post-list">
	<div class="single-post">
		<div class="post-head-wrapper">
			<div class="post-title">
				读书笔记-The Art Of Multiprocessor Programing(四)
				
			</div>
			<div class="post-meta">
    <time class="post-meta-date" itemprop="datePublished">
        2020-11-21
    </time>

    <ul class="post-meta-tags">
        
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 28 24">
    <path d="M9.777 2l11.395 11.395-7.779 7.777-11.393-11.39v-7.782h7.777zm.828-2l-10.604.001v10.609l13.392 13.39 10.607-10.605-13.395-13.395zm-6.019 7.414c-.78-.781-.779-2.047.002-2.827.781-.782 2.047-.781 2.826-.003.783.783.782 2.049 0 2.83-.779.781-2.045.781-2.828 0zm5.824 7.947l-3.537-3.535.709-.707 3.535 3.535-.707.707zm4.242 0l-5.658-5.656.708-.708 5.657 5.657-.707.707zm2.121-2.121l-5.657-5.657.707-.707 5.657 5.657-.707.707z"/>
</svg>
        
        
            <li><a href="https://fzyho.github.io/tags/java/" title="java">java</a></li>
        
            <li><a href="https://fzyho.github.io/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程">多线程</a></li>
        
            <li><a href="https://fzyho.github.io/tags/%E5%B9%B6%E5%8F%91/" title="并发">并发</a></li>
        
    </ul>
</div>
		</div>
		<div class="post-body-wrapper">
			<div class="post-body" v-pre>
				
				<h2 id="异步执行调度和工作分配">异步执行、调度和工作分配<a hidden class="anchor" aria-hidden="true" href="#异步执行调度和工作分配">#</a></h2>
<h3 id="1">1、<a hidden class="anchor" aria-hidden="true" href="#1">#</a></h3>
<h3 id="2工作分配">2、工作分配<a hidden class="anchor" aria-hidden="true" href="#2工作分配">#</a></h3>
<p>工作分配的一种简单办法就是工作交易(working dealing)：一个超负荷的任务尝试着将任务分给其他的轻负荷的线程来减轻负担。这种做法有一个致命的缺点就是：如果大多数线程都是超负荷的，那么它们将会将时间浪费在交换线程的无用尝试中。因此，我们考虑工作窃取(work stealing)：一个无法工作的线程(空闲)尝试从其他线程中窃取工作。工作窃取的优点之一就是，如果所有的线程都处于忙碌状态，那么他们不必浪费事件去分配任务。</p>
<h4 id="1工作窃取">1、工作窃取<a hidden class="anchor" aria-hidden="true" href="#1工作窃取">#</a></h4>
<p>每个线程以双端队列(double-ended queue)的形式维护一个等待执行的任务池，该队列提供<code>pushBottom()</code>、<code>popBottom()</code>、<code>popTop()</code>方法(不需要<code>pushTop()</code>)。当线程创建一个新任务时，调用<code>pushBottom()</code>方法；当线程需要执行一个任务时，调用<code>popBottom()</code>。而当线程发现它的任务队列为空时，它就变成了一个窃取者：随机选取一个牺牲者(victim)线程，并调用该线程任务队列的<code>popTop()</code>方法窃取任务。
如下是工作窃取的一种简单实现，所有工作线程共享一个DEQueue数组，每个DEQueue对应一个线程。为简化逻辑，这里忽略了窃取时触发异常的可能性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">WorkStealingThread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DEQueue</span><span class="o">[]</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">me</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Random</span> <span class="n">random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">WorkStealingThread</span><span class="o">(</span><span class="n">DEQueue</span><span class="o">[]</span> <span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">me</span> <span class="o">=</span> <span class="n">ThreadID</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">me</span><span class="o">].</span><span class="na">popBottom</span><span class="o">();</span> <span class="c1">// pop first task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// if there is a task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>          <span class="c1">// execute it and then
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">task</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">me</span><span class="o">].</span><span class="na">popBottom</span><span class="o">();</span> <span class="c1">// pop the next task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// steal a task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="kt">int</span> <span class="n">victim</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">()</span> <span class="o">%</span> <span class="n">queue</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(!</span><span class="n">queue</span><span class="o">[</span><span class="n">victim</span><span class="o">].</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">task</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">victim</span><span class="o">].</span><span class="na">popTop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为保证向前推进，必须保证那些仍有工作的线程不能无故地被除了工作窃取以外的无事可做的线程所延迟。因此在线程试图窃取其他线程的工作前，调用<code>Thread.yield()</code>方法，来将窃取线程的处理器让出给其他线程，从而允许未被调度的线程得以推进。</p>
<h3 id="3工作窃取的双端队列work-stealing-dequeues">3、工作窃取的双端队列(Work-Stealing Dequeues)<a hidden class="anchor" aria-hidden="true" href="#3工作窃取的双端队列work-stealing-dequeues">#</a></h3>
<p>理想情况下，若有可用任务，则工作窃取应该提供可线性化的实现——其出队方法应总是返回一个任务。而实际上可以采用更弱的条件——允许<code>popTop()</code>的调用在出现并发冲突时返回null。如此快速失败可以提高效率，且这样让线程在不同的随机的DEQueue上重试<code>popTop()</code>更有意义。
工作窃取DEQueue可以有两种实现：有界容量和无界容量。</p>
<h4 id="1有界工作窃取双端队列a-bounded-work-stealing-dequeue">1、有界工作窃取双端队列(A Bounded Work-Stealing Dequeue)<a hidden class="anchor" aria-hidden="true" href="#1有界工作窃取双端队列a-bounded-work-stealing-dequeue">#</a></h4>
<p>BoundedDEqueue的基本思想就是让<code>pushBottom()</code>和<code>popBottom()</code>方法在通常情形下仅使用读/写方式对<code>bottom</code>引用进行操作，而一旦<code>bottom</code>和<code>top</code>很接近时(队列中可能只有一个元素)，<code>popBottom</code>转而调用<code>compareAndSet()</code>方法以与潜在的<code>popTop()</code>协调。</p>
<p>需要明确的一点是，每个DEQueue通常情况下都是在单线程运行的，因此<code>pushBottom()</code>和<code>popBottom()</code>以及这两方法各自之间都不会发生并发。并发冲突只会出现在<code>popBottom()</code>与<code>popTop()</code>以及<code>popTop()</code>之间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">BDEQueue</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Runnable</span><span class="o">[]</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">volatile</span> <span class="kt">int</span> <span class="n">bottom</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">top</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">BDEQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">[</span><span class="n">capacity</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">top</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">pushBottom</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">tasks</span><span class="o">[</span><span class="n">bottom</span><span class="o">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">bottom</span><span class="o">++;</span> <span class="n">volatile</span><span class="err">写放在最后，以冲刷缓存，使此前所有操作对其他线程可见。</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Runnable</span> <span class="nf">popTop</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span><span class="o">[]</span> <span class="n">stamp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stamp</span><span class="o">),</span> <span class="n">newTop</span> <span class="o">=</span> <span class="n">oldTop</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldStamp</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">newStamp</span> <span class="o">=</span> <span class="n">oldStamp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">bottom</span> <span class="o">&lt;=</span> <span class="n">oldTop</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">[</span><span class="n">oldTop</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">newTop</span><span class="o">,</span> <span class="n">oldStamp</span><span class="o">,</span> <span class="n">newStamp</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Runnable</span> <span class="nf">popBottom</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">bottom</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">bottom</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">[</span><span class="n">bottom</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span><span class="o">[]</span> <span class="n">stamp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stamp</span><span class="o">),</span> <span class="n">newTop</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldStamp</span> <span class="o">=</span> <span class="n">stamp</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">newStamp</span> <span class="o">=</span> <span class="n">oldStamp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// no conflict with thieves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="o">(</span><span class="n">bottom</span> <span class="o">&gt;</span> <span class="n">oldTop</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// possible conflict: try to pop it ourselves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="o">(</span><span class="n">bottom</span> <span class="o">==</span> <span class="n">oldTop</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// even if stolen by other, queue will be empty, reset bottom
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// 必须先重置bottom再重置top，从而保证与bottom &gt; oldTop的逻辑一致性。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">newTop</span><span class="o">,</span> <span class="n">oldStamp</span><span class="o">,</span> <span class="n">newStamp</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2无界工作窃取双端队列an-unbounded-work-stealing-dequeue">2、无界工作窃取双端队列(An Unbounded Work-Stealing DEQueue)<a hidden class="anchor" aria-hidden="true" href="#2无界工作窃取双端队列an-unbounded-work-stealing-dequeue">#</a></h4>
<p>BEQueue的局限性在于它要求队列具有固定的大小。而很多时候这种大小是很难预测的。因此考虑一种无界双端队列以按需调整自己的大小。
使用一个循环数组来实现UnBoundedDEQueue，其<code>top</code>与<code>bottom</code>与BDEQueue一样(除了求索引时需要对数组容量求模以外)。使用循环数组不需重置<code>top</code>和<code>bottom</code>且<code>top</code>是递增的，因此也无需使用<code>AtomicStampedReference</code>。另外，当<code>pushBottom</code>时循环数组已满，则将原队列所有任务拷贝到更大的数组中去。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">UDEQueue</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">LOG_CAPACITY</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">volatile</span> <span class="n">CircularArray</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">volatile</span> <span class="kt">int</span> <span class="n">bottom</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">top</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UDEQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">LOG_CAPACITY</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">tasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CircularArray</span><span class="o">(</span><span class="n">LOG_CAPACITY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">top</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">localTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">localBottom</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">;</span> <span class="c1">// read bottom after top 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="o">(</span><span class="n">localBottom</span> <span class="o">&lt;=</span> <span class="n">localTop</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">pushBottom</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldBottom</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">CircularArray</span> <span class="n">currentTasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">oldBottom</span> <span class="o">-</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">currentTasks</span><span class="o">.</span><span class="na">capacity</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">currentTasks</span> <span class="o">=</span> <span class="n">currentTasks</span><span class="o">.</span><span class="na">resize</span><span class="o">(</span><span class="n">oldBottom</span><span class="o">,</span> <span class="n">oldTop</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">tasks</span> <span class="o">=</span> <span class="n">currentTasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">tasks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">oldBottom</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">bottom</span> <span class="o">=</span> <span class="n">oldBottom</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Runnable</span> <span class="nf">popTop</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">newTop</span> <span class="o">=</span> <span class="n">oldTop</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldBottom</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">;</span> <span class="c1">// important that top read before bottom
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">CircularArray</span> <span class="n">currentTasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">oldBottom</span> <span class="o">-</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">oldTop</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">newTop</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// fetch and increment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Runnable</span> <span class="nf">popBottom</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">CircularArray</span> <span class="n">currentTasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">bottom</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">newTop</span> <span class="o">=</span> <span class="n">oldTop</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		    <span class="c1">// 队列为空，修正bottom并返回null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">bottom</span> <span class="o">=</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">bottom</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(!</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">newTop</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 到此行表明队列只剩最后一个任务且必有一个线程(可能是自己)窃取了最后的任务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 因此将bottom更新为 与 top相等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">bottom</span> <span class="o">=</span> <span class="n">oldTop</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">class</span> <span class="nc">CircularArray</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="kt">int</span> <span class="n">logCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="n">Runnable</span><span class="o">[]</span> <span class="n">currentTasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">CircularArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">logCapacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="o">.</span><span class="na">logCapacity</span> <span class="o">=</span> <span class="n">logCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">currentTasks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">logCapacity</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="nf">capacity</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">logCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">Runnable</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">currentTasks</span><span class="o">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">capacity</span><span class="o">()];</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		    <span class="c1">// 通过取模的下标放置/获取任务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		    <span class="c1">// 故扩容后，capacity改变，top和bottom不变，也可以获取原来的任务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">this</span><span class="o">.</span><span class="na">currentTasks</span><span class="o">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">capacity</span><span class="o">()]</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">CircularArray</span> <span class="nf">resize</span><span class="o">(</span><span class="kt">int</span> <span class="n">bottom</span><span class="o">,</span> <span class="kt">int</span> <span class="n">top</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">CircularArray</span> <span class="n">newTasks</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">					<span class="k">new</span> <span class="n">CircularArray</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logCapacity</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">top</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bottom</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">newTasks</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">newTasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3工作平衡">3、工作平衡<a hidden class="anchor" aria-hidden="true" href="#3工作平衡">#</a></h3>
<p>通过工作窃取可以让空闲线程从其他线程中窃取任务。另外，我们也可以通过工作平衡的方式，周期性地让线程随机选取一个伙伴，并对其工作负载进行平衡。可以尽量让轻负载的线程(空闲线程)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">WorkSharingThread</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Queue</span><span class="o">[]</span> <span class="n">queue</span><span class="o">;</span> <span class="c1">// 此队列的enq()和deq()方法可能是部分的(deq只有在队列中有任务才返回)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Random</span> <span class="n">random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">THRESHOLD</span> <span class="o">=</span> <span class="mi">128</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">WorkSharingThread</span><span class="o">(</span><span class="n">Queue</span><span class="o">[]</span> <span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="o">.</span><span class="na">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">me</span> <span class="o">=</span> <span class="n">ThreadID</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">me</span><span class="o">].</span><span class="na">deq</span><span class="o">();</span>  <span class="c1">// dequeue a task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>     <span class="c1">// run it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">queue</span><span class="o">[</span><span class="n">me</span><span class="o">].</span><span class="na">size</span><span class="o">();</span>      <span class="c1">// time to rebalance?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="kt">int</span> <span class="n">victim</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// lock in ID order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="kt">int</span> <span class="n">min</span> <span class="o">=</span> <span class="o">(</span><span class="n">victim</span> <span class="o">&lt;=</span> <span class="n">me</span><span class="o">)</span> <span class="o">?</span> <span class="n">victim</span> <span class="o">:</span> <span class="n">me</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="o">(</span><span class="n">victim</span> <span class="o">&lt;=</span> <span class="n">me</span><span class="o">)</span> <span class="o">?</span> <span class="n">me</span> <span class="o">:</span> <span class="n">victim</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 锁的顺序要固定，先小后大，防止死锁。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">[</span><span class="n">min</span><span class="o">])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="kd">synchronized</span> <span class="o">(</span><span class="n">queue</span><span class="o">[</span><span class="n">max</span><span class="o">])</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">balance</span><span class="o">(</span><span class="n">queue</span><span class="o">[</span><span class="n">min</span><span class="o">],</span> <span class="n">queue</span><span class="o">[</span><span class="n">max</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">balance</span><span class="o">(</span><span class="n">Queue</span> <span class="n">q0</span><span class="o">,</span> <span class="n">Queue</span> <span class="n">q1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Queue</span> <span class="n">qMin</span> <span class="o">=</span> <span class="o">(</span><span class="n">q0</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">q1</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">?</span> <span class="n">q0</span> <span class="o">:</span> <span class="n">q1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Queue</span> <span class="n">qMax</span> <span class="o">=</span> <span class="o">(</span><span class="n">q0</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">q1</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">?</span> <span class="n">q1</span> <span class="o">:</span> <span class="n">q0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="o">(</span><span class="n">qMax</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">qMin</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">THRESHOLD</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span> <span class="o">(</span><span class="n">qMax</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">qMin</span><span class="o">.</span><span class="na">size</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">				<span class="n">qMin</span><span class="o">.</span><span class="na">enq</span><span class="o">(</span><span class="n">qMax</span><span class="o">.</span><span class="na">deq</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="1无锁的无界栈lock-free-unbounded-stack">1、无锁的无界栈(Lock Free Unbounded Stack)<a hidden class="anchor" aria-hidden="true" href="#1无锁的无界栈lock-free-unbounded-stack">#</a></h3>
<p>Stack的出口和入口都是<code>top</code>，因此只要控制<code>top</code>更新的原子性和可见性，即可实现Stack的线程安全。因此通过<code>AtomicReference</code>的<code>compareAndSet</code>来实现<code>top</code>的更新，即可实现无锁的并发栈。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockFreeStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">top</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MIN_DELAY</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_DELAY</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Backoff</span> <span class="n">backoff</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Backoff</span><span class="o">(</span><span class="n">MIN_DELAY</span><span class="o">,</span> <span class="n">MAX_DELAY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryPush</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">node</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">node</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">tryPush</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">backoff</span><span class="o">.</span><span class="na">backoff</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="n">Node</span> <span class="nf">tryPop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">oldTop</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">oldTop</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">throw</span> <span class="k">new</span> <span class="n">EmptyException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">newTop</span> <span class="o">=</span> <span class="n">oldTop</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">(</span><span class="n">top</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldTop</span><span class="o">,</span> <span class="n">newTop</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">oldTop</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">returnNode</span> <span class="o">=</span> <span class="n">tryPop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">returnNode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">returnNode</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">backoff</span><span class="o">.</span><span class="na">backoff</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当然，如此的无锁Stack的<code>top</code>字段是一个争用源，而且还是一个一个顺序瓶颈——方法调用只能根据<code>top</code>字段的<code>CompareAndSet</code>方法的成功返回的顺序 依次顺序进行。</p>
<h3 id="2消除elimination">2、消除(Elimination)<a hidden class="anchor" aria-hidden="true" href="#2消除elimination">#</a></h3>
<p>由于LockFreeStack存在顺序瓶颈(Sequential Bottleneck)，为降低其压力，可利用stack的一种现象——若一个<code>push</code>后面跟着<code>pop</code>，则两个操作相互抵消，stack的状态相当于没有发生改变。<!-- raw HTML omitted -->
如下图所示，可以通过使用一个数组作为缓冲来消除其他线程。其中，线程随机选取一个数组位置的来尝试发现互补的调用。互补的<code>push</code>和<code>pop</code>调用对则相互交换数值并返回。若不是互补的(如 <code>push</code>和<code>push</code>，<code>pop</code>和<code>pop</code>)，则要么在新的数组位置中重新尝试，要么直接访问共享的数据结构(本章即 LockFreeStack)。</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/C54B8819167E43A98D351C7A555DEA59?method=download&amp;shareKey=26a75db4c87fa9a330e1901122037050" alt="image"><!-- raw HTML omitted -->
通过将EliminationArray作为LockFreeStack的后退模式——每个线程访问LockFreeStack失败后(即<code>compareAndSet()</code>失败)，该线程则尝试使用数组来消除它的调用。若不能消除，则再重新访问LockFreeStack。</p>
<h3 id="3消除式后退栈eliminationbackoffstack">3、消除式后退栈(EliminationBackoffStack)<a hidden class="anchor" aria-hidden="true" href="#3消除式后退栈eliminationbackoffstack">#</a></h3>
<h4 id="1无锁交换机a-lock-free-exchanger">1、无锁交换机(A Lock-Free Exchanger)<a hidden class="anchor" aria-hidden="true" href="#1无锁交换机a-lock-free-exchanger">#</a></h4>
<p>从一个高的层次来看，交换机让第一个到达的线程写入自己的值，然后旋转等待直到第二个线程的到来。随后，第二个线程检测到第一个线程在等待，则读取写入的值并向交换机发出信号。两方都读取到值后，返回。若第二个线程没有出现，则第一个线程超时使得其能够离开交换机继续操作。<!-- raw HTML omitted --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">LockFreeExchanger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">EMPTY</span> <span class="o">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">WAITING</span> <span class="o">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">BUSY</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">slot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">exchange</span><span class="o">(</span><span class="n">T</span> <span class="n">myItem</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">long</span> <span class="n">timeBound</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">+</span> <span class="n">nanos</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span><span class="o">[]</span> <span class="n">stampHolder</span> <span class="o">=</span> <span class="o">{</span> <span class="n">EMPTY</span> <span class="o">};</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">timeBound</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">T</span> <span class="n">yrItem</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stampHolder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">stampHolder</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span> <span class="o">(</span><span class="n">stamp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">EMPTY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">slot</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">yrItem</span><span class="o">,</span> <span class="n">myItem</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">while</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">timeBound</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">yrItem</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stampHolder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="o">(</span><span class="n">stampHolder</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">BUSY</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">							<span class="n">slot</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">							<span class="k">return</span> <span class="n">yrItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">						<span class="o">}</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="o">(</span><span class="n">slot</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">myItem</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">yrItem</span> <span class="o">=</span> <span class="n">slot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stampHolder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">						<span class="n">slot</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">EMPTY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="n">yrItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">WAITING</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="o">(</span><span class="n">slot</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">yrItem</span><span class="o">,</span> <span class="n">myItem</span><span class="o">,</span> <span class="n">WAITING</span><span class="o">,</span> <span class="n">BUSY</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="n">yrItem</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">BUSY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">default</span><span class="o">:</span> <span class="c1">// impossible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上述代码所示，一个线程读取slot状态，有如下流程：</p>
<ul>
<li>若状态为<code>EMPTY</code>，尝试将数据写入slot中并将状态设置为<code>WAITING</code>。若失败，则有其他线程成功，重试；若成功，则自旋以等待另一线程将其交换。另一线程交换数据后，会将状态设置为<code>BUSY</code>，从而告知正在自旋等待的线程已完成交换，可以读取slot中的数据并更新状态为<code>EMPTY</code>。若超时，则将slot中的数据和状态重置。</li>
<li>若状态为<code>WAITING</code>，则说明某线程正在自选等待且slot有数据，因此通过<code>compareAndSet()</code>方法获取数据并更新状态为<code>BUSY</code>，以通知该线程结束自旋。若<code>compareAndSet()</code>失败，则重试直至超时。</li>
<li>若状态为<code>BUSY</code>，说明另外有两个线程正在通过此slot进行交换，此线程需要重试以等待交换结束。</li>
</ul>
<h4 id="2消除数组eliminationarray">2、消除数组(EliminationArray)<a hidden class="anchor" aria-hidden="true" href="#2消除数组eliminationarray">#</a></h4>
<p>EliminationArray即是一个交换机(Exchanger)数组，要进行交换的线程从数组中随机选择一个对象，并调用该对象的<code>excahnge()</code>方法来与另一线程交换数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">EliminationArray</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">duration</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">LockFreeExchanger</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;[]</span> <span class="n">exchanger</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">Random</span> <span class="n">random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">EliminationArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">exchanger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockFreeExchanger</span><span class="o">[</span><span class="n">capacity</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">exchanger</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockFreeExchanger</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">visit</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">,</span> <span class="kt">int</span> <span class="n">range</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">range</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">exchanger</span><span class="o">[</span><span class="n">slot</span><span class="o">].</span><span class="na">exchange</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>每次随机数组时，线程可动态选择数组的子范围。子范围的选择由RangePolicy对象决定，每个调用<code>push/pop</code>的线程都有一个ThreadLocal的RangePolicy对象。EliminationArray的范围选择是重要的，范围越大，线程在<code>BUSY</code>状态的交换机上等待的可能性越低。因此线程越少，范围应该越小。<strong>因此一种简单的范围选择策略是——随着失败次数的增加而收缩范围</strong>。</p>
<blockquote>
<p>本章实现的EliminationArray模块，实际上效率并不算高效。<a href="http://www.cs.tau.ac.il/~shanir/nir-pubs-web/Papers/SPAA2005.pdf"> Using elimination to implement scalable and lock-free fifo queues</a>中提出了一种更加高效的实现。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">EliminationBackoffStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">LockFreeStack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">	<span class="n">EliminationArray</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">eliminationArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EliminationArray</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">RangePolicy</span><span class="o">&gt;</span> <span class="n">policy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">RangePolicy</span><span class="o">&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">protected</span> <span class="kd">synchronized</span> <span class="n">RangePolicy</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="k">new</span> <span class="n">RangePolicy</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">RangePolicy</span> <span class="n">rangePolicy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">tryPush</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">T</span> <span class="n">otherValue</span> <span class="o">=</span> <span class="n">eliminationArray</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">rangePolicy</span><span class="o">.</span><span class="na">getRange</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="o">(</span><span class="n">otherValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationSuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span><span class="o">;</span> <span class="c1">// exchanged with pop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationTimeout</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">T</span> <span class="nf">pop</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">EmptyException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">RangePolicy</span> <span class="n">rangePolicy</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Node</span> <span class="n">popNode</span> <span class="o">=</span> <span class="n">tryPop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">(</span><span class="n">popNode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">popNode</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">T</span> <span class="n">otherValue</span> <span class="o">=</span> <span class="n">eliminationArray</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">rangePolicy</span><span class="o">.</span><span class="na">getRange</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="o">(</span><span class="n">otherValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">						<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationSuccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="n">otherValue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">					<span class="o">}</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TimeoutException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">rangePolicy</span><span class="o">.</span><span class="na">recordEliminationTimeout</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">				<span class="o">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
			</div>
			<div class="post-copyright">
				<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
	<img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
</a>
<br />本作品采用
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>
进行许可。
<br />
转载时请附上原文链接以注明出处，图片在使用时请保留全部内容(可适当缩放)并附上图片所属的文章链接。若进行商业性使用，请先联系笔者获取许可。
			</div>
		</div>
		<div class="post-footer-wrapper">
			<hr class="hr-fade"/>
			<div class="post-comment-wrapper"></div> 
		</div>
	</div>
</div>

</main>
	</body>
</html>

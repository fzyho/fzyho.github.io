<!DOCTYPE html>
<html><meta charset="utf-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta name="keywords" content="">
<meta name="description" content="">

<title>从CLH锁聊聊AQS的设计</title>


<meta name="generator" content="Hugo 0.76.4" />




<link rel="stylesheet" href="/css/main.min.css">
<div class="fixed-header-slide">
    <div class="fixed-header-wrap">
        <header class="header">
            <nav class="nav">
                <div class="logo">
                    <a href="http://localhost:1313/" title="Lzero的小站">Lzero的小站</a>
                </div>
                <ul class="menu" id="menu" onscroll="menu_on_scroll()">
                    <li>
                        <a href="http://localhost:1313/about" title="About">
                            <span>About</span>
                        </a>
                    </li>
                    <li>
                        <a href="http://localhost:1313/archives" title="Archive">
                            <span>Archive</span>
                        </a>
                    </li>
                    <li>
                        <a href="http://localhost:1313/brochures" title="Brochure">
                            <span>Brochure</span>
                        </a>
                    </li></ul>
            </nav>
        </header>
    </div>
</div><body>
		<main class="content">







  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3&#43;Aro6EYUG4&#43;cU&#43;KJWu/X" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c&#43;Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI&#43;sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC&#43;Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    'use strict';
    
    
    var tables = document.querySelectorAll('.post-body > table');
    for (let i = 0; i < tables.length; i++) {
      var table = tables[i];
      var wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentElement.replaceChild(wrapper, table);
      wrapper.appendChild(table);
    }
    


    
    
      var mathElements = document.getElementsByClassName('math');
      var options = {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "$$\n", right: "\n$$", display: true },
          { left: "$", right: "$", display: false },
        ],
      };

      renderMathInElement(document.querySelector('.post-body'), options);
    
    
  });
</script>


<div class="wrapper-toc">
    <div class="toc">
		
		
		
			<div class="toc-content">
			
				
				
				
				<label style="margin: auto;">-Catalogue-</label>
				
				
				<ul></ul>
					
						
						
							
								
								
								
								
									
										<ul>
									
								
								
									<li>
										<a href="#clh-lock" onclick="onNavClick(`#clh-lock-nav`)" id="clh-lock-nav" class="animated-visibility">
											CLH Lock
										</a>
									</li>
								
								
							
						
					
						
						
							
								
								
								
								
								
									<li>
										<a href="#aqs" onclick="onNavClick(`#aqs-nav`)" id="aqs-nav" class="animated-visibility">
											AQS
										</a>
									</li>
								
								
							
						
					
				</ul>
			</div>
		
    </div>
</div>


<div class="post-list">
	<div class="single-post">
		<div class="post-head-wrapper">
			<div class="post-title">
				从CLH锁聊聊AQS的设计
				
				<div class="post-meta">
    <time class="post-meta-date" itemprop="datePublished">
        2021-09-08
    </time>

    <ul class="post-meta-tags">
        #
        
        
        
            <li><a href="http://localhost:1313/tags/java/" title="java">java</a></li>
        
            <li><a href="http://localhost:1313/tags/%E9%98%9F%E5%88%97%E9%94%81/" title="队列锁">队列锁</a></li>
        
            <li><a href="http://localhost:1313/tags/aqs/" title="AQS">AQS</a></li>
        
            <li><a href="http://localhost:1313/tags/%E5%90%8C%E6%AD%A5/" title="同步">同步</a></li>
        
    </ul>
</div>
			</div>
		</div>
        
		<div class="post-body-wrapper">
			<div class="post-body" v-pre>
				
				
				<p>AbstractQueuedSynchronizer(简称AQS)是Java并发工具包(JUC)中的锁和同步器(Semophore、CountDownLatch等)的基础，它提供了一个上锁、释放以及锁等待的整体流程框架。AQS是基于一个FIFO的等待队列实现的，它是CLH队列锁(Queuing Lock)的一种变体。因此，秉着从简到深的想法，我们先来了解下CLH队列锁。</p>
<h2 id="clh-lock">CLH Lock<a hidden class="anchor" aria-hidden="true" href="#clh-lock">#</a></h2>
<p>CLH队列锁是一种自旋锁。正如名字所描述的，是一种基于队列/链表，通过将线程组织成一个队列的形式来一次进行上锁-处理-释放的同步方式。在队列中，每个线程通过检测其<strong>前驱线程</strong>是否已完成(<strong>获得并释放锁</strong>)来判断是否轮到自己。每个线程在不同的存储单元自旋，从而降低cache一致性流，并提高临界区利用率。最后队列FIFO的特性保证了公平性。</p>
<p>一开始，CLHLock的队列只有一个尾部节点。然后线程A和B同时竞争上锁，两线程会调用<strong>原子的</strong>GetAndSet()的方式，获取尾部节点，并将此节点设置为自己的前驱节点作为，然后将自己线程转成节点插入队列的尾部。完成这些操作后，便进入自旋状态，直到前驱节点释放锁，即字段<code>locked</code>为<code>false</code>。</p>
<h2 id="aqs">AQS<a hidden class="anchor" aria-hidden="true" href="#aqs">#</a></h2>

			</div>
			<div class="post-copyright">
				<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
	<img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
</a>
<br />本作品采用
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>
进行许可。
<br />
转载时请附上原文链接以注明出处，图片在使用时请保留全部内容(可适当缩放)并附上图片所属的文章链接。若进行商业性使用，请先联系笔者获取许可。
			</div>
		</div>
		<div class="post-footer-wrapper">
			<hr class="hr-fade"/>
			<div class="post-comment-wrapper"><div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
<script>
  var gitalk = new Gitalk({
    id: '2021-09-08 14:16:15 \u002b0800 CST',
    title: '从CLH锁聊聊AQS的设计',
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    body: decodeURI(location.href)
  });
  gitalk.render('gitalk-container');
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript></div> 
		</div>
	</div>
</div>

</main>
	</body>
</html>
